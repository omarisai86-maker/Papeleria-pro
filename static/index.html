<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PapelerÃ­a PRO</title>

<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#1e293b">

<script src="https://unpkg.com/html5-qrcode"></script>

<style>

body{
    font-family: 'Segoe UI', sans-serif;
    margin:0;
    background:#f1f5f9;
}

/* HEADER */
.header{
    background:#1e293b;
    color:white;
    padding:15px;
    text-align:center;
    font-size:20px;
    font-weight:bold;
}

/* TABS */
.tabs{
    display:flex;
    justify-content:space-around;
    background:white;
    box-shadow:0 2px 5px rgba(0,0,0,0.1);
}

.tab-button{
    flex:1;
    padding:15px;
    border:none;
    background:none;
    font-size:14px;
    font-weight:600;
    cursor:pointer;
}

.tab-button.active{
    border-bottom:3px solid #2563eb;
    color:#2563eb;
}

/* CONTENIDO */
.tab-content{
    display:none;
    padding:20px;
}

.tab-content.active{
    display:block;
}

/* CARD */
.card{
    background:white;
    padding:20px;
    border-radius:12px;
    box-shadow:0 4px 12px rgba(0,0,0,0.05);
    margin-bottom:20px;
}

/* INPUTS */
input{
    width:100%;
    padding:10px;
    margin:8px 0;
    border-radius:8px;
    border:1px solid #cbd5e1;
    font-size:14px;
}

button{
    padding:10px 15px;
    border:none;
    border-radius:8px;
    cursor:pointer;
    font-weight:bold;
}

.btn-primary{
    background:#2563eb;
    color:white;
}

.btn-danger{
    background:#ef4444;
    color:white;
}

/* TABLE */
table{
    width:100%;
    border-collapse:collapse;
}

th{
    background:#e2e8f0;
    padding:10px;
}

td{
    padding:8px;
    border-bottom:1px solid #e2e8f0;
    text-align:center;
}

/* BUSCADOR */
.search-box{
    margin-bottom:15px;
}

#reader{
    width:100%;
    margin-top:10px;
}

</style>
</head>
<body>

<div class="header">ðŸ“¦ PapelerÃ­a PRO</div>

<div class="tabs">
    <button class="tab-button active" onclick="mostrarTab('captura',this)">Captura</button>
    <button class="tab-button" onclick="mostrarTab('lista',this)">Lista</button>
    <button class="tab-button" onclick="mostrarTab('historialTab',this)">Historial</button>
</div>

<!-- CAPTURA -->
<div id="captura" class="tab-content active">

<div class="card">

<button class="btn-primary" onclick="iniciarCamara()">ðŸ“· Escanear</button>
<div id="reader"></div>

<input id="codigo" placeholder="CÃ³digo" onblur="buscarNombre()">
<input id="nombre" placeholder="Nombre">
<input id="compra" type="number" placeholder="Precio Compra">
<input id="porcentaje" type="number" placeholder="% Ganancia">
<input id="venta" type="number" placeholder="Precio Venta" readonly>
<input id="existente" type="number" placeholder="Cantidad existente">
<input id="comprar_cantidad" type="number" placeholder="Cantidad a comprar">

<button class="btn-primary" onclick="agregar()">Guardar Producto</button>

</div>
</div>

<!-- LISTA -->
<div id="lista" class="tab-content">

<div class="card">

<input class="search-box" id="buscador" placeholder="ðŸ” Buscar por cÃ³digo o nombre..." oninput="filtrar()">

<table>
<thead>
<tr>
<th>ID</th>
<th>CÃ³digo</th>
<th>Nombre</th>
<th>Existente</th>
<th>A Comprar</th>
<th>AcciÃ³n</th>
</tr>
</thead>
<tbody id="tabla"></tbody>
</table>

</div>
</div>

<!-- HISTORIAL -->
<div id="historialTab" class="tab-content">

<div class="card">
<table>
<thead>
<tr>
<th>ID</th>
<th>CÃ³digo</th>
<th>Nombre</th>
<th>Existente</th>
<th>A Comprar</th>
</tr>
</thead>
<tbody id="historial"></tbody>
</table>
</div>

</div>

<script>

/* TABS */
function mostrarTab(id,btn){
    document.querySelectorAll(".tab-content").forEach(t=>t.classList.remove("active"));
    document.querySelectorAll(".tab-button").forEach(b=>b.classList.remove("active"));
    document.getElementById(id).classList.add("active");
    btn.classList.add("active");

    if(id==="lista") cargar();
    if(id==="historialTab") cargarHistorial();
}

/* BUSCADOR */
function filtrar(){
    const filtro = buscador.value.toLowerCase();
    const filas = tabla.getElementsByTagName("tr");

    for(let i=0;i<filas.length;i++){
        const texto = filas[i].innerText.toLowerCase();
        filas[i].style.display = texto.includes(filtro) ? "" : "none";
    }
}

/* BUSCAR NOMBRE */
async function buscarNombre(){
    if(!codigo.value) return;
    const res = await fetch(`/buscar_producto/${codigo.value}`);
    const data = await res.json();
    if(data.nombre) nombre.value = data.nombre;
}

/* CARGAR LISTA */
async function cargar(){
    const res = await fetch("/productos");
    const data = await res.json();
    tabla.innerHTML="";

    data.forEach(p=>{
        tabla.innerHTML+=`
        <tr>
        <td>${p[0]}</td>
        <td>${p[1]}</td>
        <td>${p[2]}</td>
        <td>${p[6]}</td>
        <td>${p[7]}</td>
        <td><button class="btn-danger" onclick="comprar(${p[0]})">Comprar</button></td>
        </tr>`;
    });
}

/* HISTORIAL */
async function cargarHistorial(){
    const res = await fetch("/historial");
    const data = await res.json();
    historial.innerHTML="";

    data.forEach(p=>{
        historial.innerHTML+=`
        <tr>
        <td>${p[0]}</td>
        <td>${p[1]}</td>
        <td>${p[2]}</td>
        <td>${p[6]}</td>
        <td>${p[7]}</td>
        </tr>`;
    });
}

/* AGREGAR */
async function agregar(){
    const ventaCalc = compra.value*(1+porcentaje.value/100);

    await fetch("/productos",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
            codigo:codigo.value,
            nombre:nombre.value,
            compra:parseFloat(compra.value)||0,
            porcentaje:parseFloat(porcentaje.value)||0,
            venta:ventaCalc||0,
            cantidad_existente:parseInt(existente.value)||0,
            cantidad_comprar:parseInt(comprar_cantidad.value)||0
        })
    });

    alert("Guardado âœ…");
}

/* COMPRAR */
async function comprar(id){
    await fetch(`/productos/${id}`,{method:"DELETE"});
    cargar();
    cargarHistorial();
}

/* CALCULAR */
compra.addEventListener("input",calc);
porcentaje.addEventListener("input",calc);

function calc(){
    if(compra.value && porcentaje.value){
        venta.value = compra.value*(1+porcentaje.value/100);
    }
}

/* ESCANER */
function iniciarCamara(){
    const scanner = new Html5Qrcode("reader");
    Html5Qrcode.getCameras().then(devices=>{
        scanner.start(
            devices[devices.length-1].id,
            {fps:10,qrbox:250},
            code=>{
                codigo.value=code;
                scanner.stop();
                buscarNombre();
            }
        );
    });
}

</script>

</body>
</html>
