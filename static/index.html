<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PapelerÃ­a PRO</title>

<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#2c3e50">

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body { font-family: Arial; margin: 20px; }

/* PestaÃ±as */
.tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.tab-button {
    padding: 10px 20px;
    cursor: pointer;
    border: none;
    background: #ccc;
    border-radius: 5px;
}

.tab-button.active {
    background: #2c3e50;
    color: white;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

input, button {
    padding: 8px;
    margin: 5px;
}

table {
    border-collapse: collapse;
    width: 100%;
    margin-top: 20px;
}

th, td {
    border: 1px solid #ccc;
    padding: 8px;
    text-align: center;
}

th {
    background: #f0f0f0;
}

#reader {
    width: 300px;
    margin-top: 20px;
}
</style>
</head>
<body>

<h2>ðŸ“¦ PapelerÃ­a PRO</h2>

<!-- BOTONES DE PESTAÃ‘AS -->
<div class="tabs">
    <button class="tab-button active" onclick="mostrarTab('captura', this)">ðŸ“¥ Captura</button>
    <button class="tab-button" onclick="mostrarTab('lista', this)">ðŸ“¦ Lista</button>
    <button class="tab-button" onclick="mostrarTab('historialTab', this)">ðŸ“Š Historial</button>
</div>

<!-- PESTAÃ‘A CAPTURA -->
<div id="captura" class="tab-content active">

<h3>Agregar Producto</h3>

<button onclick="iniciarCamara()">ðŸ“· Escanear</button>
<div id="reader"></div>

<br>

<input id="codigo" placeholder="CÃ³digo" onblur="buscarNombre()">
<input id="nombre" placeholder="Nombre">
<input id="compra" type="number" placeholder="Precio Compra">
<input id="porcentaje" type="number" placeholder="% Ganancia">
<input id="venta" type="number" placeholder="Precio Venta" readonly>
<input id="existente" type="number" placeholder="Cantidad existente">
<input id="comprar_cantidad" type="number" placeholder="Cantidad a comprar">

<br>
<button onclick="agregar()">Agregar</button>

</div>

<!-- PESTAÃ‘A LISTA -->
<div id="lista" class="tab-content">
<h3>ðŸ“¦ Lista de Faltantes</h3>
<table>
<thead>
<tr>
<th>ID</th>
<th>CÃ³digo</th>
<th>Nombre</th>
<th>Compra</th>
<th>%</th>
<th>Venta</th>
<th>Existente</th>
<th>A Comprar</th>
<th>AcciÃ³n</th>
</tr>
</thead>
<tbody id="tabla"></tbody>
</table>
</div>

<!-- PESTAÃ‘A HISTORIAL -->
<div id="historialTab" class="tab-content">
<h3>ðŸ“Š Historial de Compras</h3>
<table>
<thead>
<tr>
<th>ID</th>
<th>CÃ³digo</th>
<th>Nombre</th>
<th>Compra</th>
<th>%</th>
<th>Venta</th>
<th>Existente</th>
<th>A Comprar</th>
</tr>
</thead>
<tbody id="historial"></tbody>
</table>
</div>

<script>

/* CONTROL DE PESTAÃ‘AS */
function mostrarTab(id, boton) {

    document.querySelectorAll(".tab-content").forEach(tab => {
        tab.classList.remove("active");
    });

    document.querySelectorAll(".tab-button").forEach(btn => {
        btn.classList.remove("active");
    });

    document.getElementById(id).classList.add("active");
    boton.classList.add("active");

    if (id === "lista") cargar();
    if (id === "historialTab") cargarHistorial();
}

/* BUSCAR PRODUCTO */
async function buscarNombre() {
    const codigoValor = codigo.value;
    if (!codigoValor) return;

    const res = await fetch(`/buscar_producto/${codigoValor}`);
    const data = await res.json();

    if (data.nombre) {
        nombre.value = data.nombre;
    }
}

/* CARGAR LISTA */
async function cargar() {
    const res = await fetch("/productos");
    const data = await res.json();
    tabla.innerHTML = "";

    data.forEach(p => {
        tabla.innerHTML += `
        <tr>
        <td>${p[0]}</td>
        <td>${p[1]}</td>
        <td>${p[2]}</td>
        <td>${p[3]}</td>
        <td>${p[4]}</td>
        <td>${p[5]}</td>
        <td>${p[6]}</td>
        <td>${p[7]}</td>
        <td><button onclick="comprar(${p[0]})">ðŸ›’ Comprar</button></td>
        </tr>`;
    });
}

/* CARGAR HISTORIAL */
async function cargarHistorial() {
    const res = await fetch("/historial");
    const data = await res.json();
    historial.innerHTML = "";

    data.forEach(p => {
        historial.innerHTML += `
        <tr>
        <td>${p[0]}</td>
        <td>${p[1]}</td>
        <td>${p[2]}</td>
        <td>${p[3]}</td>
        <td>${p[4]}</td>
        <td>${p[5]}</td>
        <td>${p[6]}</td>
        <td>${p[7]}</td>
        </tr>`;
    });
}

/* AGREGAR PRODUCTO */
async function agregar() {

    const codigoInput = codigo.value;
    const nombreInput = nombre.value;
    const compraInput = parseFloat(compra.value) || 0;
    const porcentajeInput = parseFloat(porcentaje.value) || 0;
    const existenteInput = parseInt(existente.value) || 0;
    const comprarInput = parseInt(comprar_cantidad.value) || 0;

    const ventaCalculada = compraInput + (compraInput * porcentajeInput / 100);

    await fetch("/productos", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            codigo: codigoInput,
            nombre: nombreInput,
            compra: compraInput,
            porcentaje: porcentajeInput,
            venta: ventaCalculada,
            cantidad_existente: existenteInput,
            cantidad_comprar: comprarInput
        })
    });

    alert("Producto guardado âœ…");

    codigo.value = "";
    nombre.value = "";
    compra.value = "";
    porcentaje.value = "";
    venta.value = "";
    existente.value = "";
    comprar_cantidad.value = "";
}

/* COMPRAR */
async function comprar(id) {
    await fetch(`/productos/${id}`, { method: "DELETE" });
    cargar();
    cargarHistorial();
}

/* CALCULAR VENTA */
compra.addEventListener("input", calcular);
porcentaje.addEventListener("input", calcular);

function calcular() {
    if (compra.value && porcentaje.value) {
        venta.value = compra.value * (1 + porcentaje.value / 100);
    }
}

/* ESCÃNER */
let scanner;

function iniciarCamara() {
    scanner = new Html5Qrcode("reader");

    Html5Qrcode.getCameras().then(devices => {
        let cameraId = devices[devices.length - 1].id;

        scanner.start(
            cameraId,
            { fps: 10, qrbox: 250 },
            code => {
                codigo.value = code;
                scanner.stop();
                buscarNombre();
            }
        );
    });
}

</script>

</body>
</html>
