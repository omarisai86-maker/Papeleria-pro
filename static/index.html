<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PapelerÃ­a PRO</title>

<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#2c3e50">

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body { font-family: Arial; margin: 20px; }
input, button { padding: 8px; margin: 5px; }
table { border-collapse: collapse; width: 100%; margin-top: 20px; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
th { background: #f0f0f0; }
#reader { width: 300px; margin-top: 20px; }
</style>

</head>
<body>

<h2>ðŸ“¦ Lista de Faltantes</h2>

<button onclick="iniciarCamara()">ðŸ“· Escanear</button>
<div id="reader"></div>

<h3>Agregar Producto</h3>

<input id="codigo" placeholder="CÃ³digo" onblur="buscarNombre()">
<input id="nombre" placeholder="Nombre">
<input id="compra" type="number" placeholder="Precio Compra">
<input id="porcentaje" type="number" placeholder="% Ganancia">
<input id="venta" type="number" placeholder="Precio Venta" readonly>
<input id="existente" type="number" placeholder="Cantidad existente">
<input id="comprar_cantidad" type="number" placeholder="Cantidad a comprar">

<button onclick="agregar()">Agregar</button>

<table>
<thead>
<tr>
<th>ID</th>
<th>CÃ³digo</th>
<th>Nombre</th>
<th>Compra</th>
<th>%</th>
<th>Venta</th>
<th>Existente</th>
<th>A Comprar</th>
<th>AcciÃ³n</th>
</tr>
</thead>
<tbody id="tabla"></tbody>
</table>

<h2>ðŸ“Š Historial de Compras</h2>
<table>
<thead>
<tr>
<th>ID</th>
<th>CÃ³digo</th>
<th>Nombre</th>
<th>Compra</th>
<th>%</th>
<th>Venta</th>
<th>Existente</th>
<th>A Comprar</th>
</tr>
</thead>
<tbody id="historial"></tbody>
</table>

<audio id="beep" src="https://www.soundjay.com/buttons/sounds/beep-07.mp3"></audio>

<script>

async function buscarNombre() {
    const codigoValor = codigo.value;
    if (!codigoValor) return;

    const res = await fetch(`/buscar_producto/${codigoValor}`);
    const data = await res.json();

    if (data.nombre) {
        nombre.value = data.nombre;
    }
}

async function cargar() {
    const res = await fetch("/productos");
    const data = await res.json();
    tabla.innerHTML = "";

    data.forEach(p => {
        tabla.innerHTML += `
        <tr>
        <td>${p[0]}</td>
        <td>${p[1]}</td>
        <td>${p[2]}</td>
        <td>${p[3]}</td>
        <td>${p[4]}</td>
        <td>${p[5]}</td>
        <td>${p[6]}</td>
        <td>${p[7]}</td>
        <td><button onclick="comprar(${p[0]})">ðŸ›’ Comprar</button></td>
        </tr>`;
    });
}

async function cargarHistorial() {
    const res = await fetch("/historial");
    const data = await res.json();
    historial.innerHTML = "";

    data.forEach(p => {
        historial.innerHTML += `
        <tr>
        <td>${p[0]}</td>
        <td>${p[1]}</td>
        <td>${p[2]}</td>
        <td>${p[3]}</td>
        <td>${p[4]}</td>
        <td>${p[5]}</td>
        <td>${p[6]}</td>
        <td>${p[7]}</td>
        </tr>`;
    });
}

async function agregar() {
    try {

        const codigoInput = document.getElementById("codigo").value.trim();
        const nombreInput = document.getElementById("nombre").value.trim();
        const compraInput = parseFloat(document.getElementById("compra").value) || 0;
        const porcentajeInput = parseFloat(document.getElementById("porcentaje").value) || 0;
        const existenteInput = parseInt(document.getElementById("existente").value) || 0;
        const comprarInput = parseInt(document.getElementById("comprar_cantidad").value) || 0;

        if (!codigoInput || !nombreInput) {
            alert("CÃ³digo y Nombre son obligatorios");
            return;
        }

        const ventaCalculada = compraInput + (compraInput * porcentajeInput / 100);

        const respuesta = await fetch(window.location.origin + "/productos", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                codigo: codigoInput,
                nombre: nombreInput,
                compra: compraInput,
                porcentaje: porcentajeInput,
                venta: ventaCalculada,
                cantidad_existente: existenteInput,
                cantidad_comprar: comprarInput
            })
        });

        if (!respuesta.ok) {
            const errorText = await respuesta.text();
            console.error("ERROR BACKEND:", errorText);
            alert("Error del servidor. Revisa consola F12.");
            return;
        }

        const data = await respuesta.json();
        console.log("Guardado:", data);

        alert("Producto guardado correctamente âœ…");

        // limpiar formulario
        document.getElementById("codigo").value = "";
        document.getElementById("nombre").value = "";
        document.getElementById("compra").value = "";
        document.getElementById("porcentaje").value = "";
        document.getElementById("venta").value = "";
        document.getElementById("existente").value = "";
        document.getElementById("comprar_cantidad").value = "";

        cargar();

    } catch (error) {
        console.error("ERROR TOTAL:", error);
        alert("No se pudo guardar. Revisa F12.");
    }
}

async function comprar(id) {
    await fetch(`/productos/${id}`, { method: "DELETE" });
    cargar();
    cargarHistorial();
}

document.getElementById("compra").addEventListener("input", calcular);
document.getElementById("porcentaje").addEventListener("input", calcular);

function calcular() {
    const compraValor = parseFloat(compra.value);
    const porcentajeValor = parseFloat(porcentaje.value);

    if (compraValor && porcentajeValor) {
        venta.value = compraValor + (compraValor * porcentajeValor / 100);
    }
}

let scanner;

function iniciarCamara() {
    scanner = new Html5Qrcode("reader");

    Html5Qrcode.getCameras().then(devices => {

        let camaraTrasera = devices.find(device =>
            device.label.toLowerCase().includes("back") ||
            device.label.toLowerCase().includes("rear") ||
            device.label.toLowerCase().includes("environment")
        );

        let cameraId = camaraTrasera ? camaraTrasera.id : devices[devices.length - 1].id;

        scanner.start(
            cameraId,
            { fps: 10, qrbox: 250 },
            code => {
                codigo.value = code;
                document.getElementById("beep").play();
                scanner.stop();
                buscarNombre();
            }
        );
    });
}

cargar();
cargarHistorial();

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/service-worker.js');
}

</script>

</body>
</html>
